<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Game Control Panel</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
        }

        button {
            background-color: #2BA3C1;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-right: 20px;
            margin-bottom: 10px;
            cursor: pointer;
            min-width: 240px;
        }

        select {
            padding: 10px 20px;
            text-align: center;
            display: inline-block;
            font-size: 16px;
            margin-right: 20px;
            margin-bottom: 10px;
            cursor: pointer;
            min-width: 240px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            margin-right: 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .planet {
            position: relative;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .planet-popup {
            position: relative;
            background-color: white;
            border: 1px solid black;
            padding: 10px;
            display: none;
        }

        .planet:hover .planet-popup {
            display: block;
            z-index: 1;
        }

        .wormhole {
            position: relative;
            background-color: black;
            height: 10px;
            width: 10px;
            transition: transform 0.2s;
            z-index: 0;
        }

        .wormhole:hover {
            transform: scale(1.2);
            z-index: 1;
        }

        .wormhole-popup {
            position: relative;
            background-color: white;
            border: 1px solid black;
            padding: 10px;
            display: none;
        }

        .wormhole:hover + .wormhole-popup {
            display: block;
        }

        #container {
            border: solid black;
            height: 100%;
            background-color: #EEEEEE;
            flex: 1;
            box-sizing: border-box; /* add this line */
            padding: 10px; /* add your desired padding */
        }

        main {
            flex: 1;
            display: flex; /* add this line */
            flex-direction: column; /* add this line */
            box-sizing: border-box; /* add this line */
            padding: 10px; /* add your desired padding */
        }
    </style>
</head>
<body>

<h1>Game Control Panel</h1>

<main>
    <div>
        <button type="button" onclick="joinUiSocket()">Join websocket for UI</button>
        <input type="text" id="txbConnectedToServer" readonly>
    </div>

    <div>
        <button type="button" onclick="getGameKey()">Get Game Key</button>
        <select id="selGameKey">
        </select>
    </div>

    <div>
        <button type="button" onclick="createGame()">Create Game</button>
        <select id="dropdownList">
            <option value="SINGLE_PLAYER">SINGLE_PLAYER</option>
            <option value="MULTI_PLAYER">MULTI_PLAYER</option>
            <option value="QUALIFYING">QUALIFYING</option>
        </select>
        <select id="selGameId">
        </select>
    </div>

    <div>
        <button type="button" onclick="connectWebSocket()">Connect Control WebSocket</button>
    </div>

    <div>
        <button type="button" onclick="startGame()">Start Game</button>
        <button type="button" onclick="stopGame()">Stop Game</button>
    </div>

    <div>
        <button type="button" onclick="getBots()">Get Bots</button>
        <button type="button" onclick="testUi()">Test</button>
    </div>

    <div id="container"></div>

</main>


<script type="text/javascript" src="js/dropdownlist.js"></script>
<script type="text/javascript">

    const UrlRoot = 'http://localhost:8080';
    let currentGameKey = '';
    let currentGameId = '';

    const gameKeySelector = new DropdownList("selGameKey", event => currentGameKey = event.target.value);
    const gameIdSelector = new DropdownList("selGameId", event => currentGameId = event.target.value);

    currentGameKey = gameKeySelector.selected;
    currentGameId = gameIdSelector.selected;

    const joinUiSocket = async () => {
        // Create a new WebSocket connection to the server
        const socket = new WebSocket(`ws://localhost:8080/planets`);

        socket.addEventListener('open', (event) => {
            const txbConnectedToServer = document.getElementById('txbConnectedToServer');
            txbConnectedToServer.value = "Open";
        });

        socket.addEventListener('close', (event) => {
            const txbConnectedToServer = document.getElementById('txbConnectedToServer');
            txbConnectedToServer.value = "Closed";
        });

        // When the WebSocket connection is open, send a message to request the JSON data
        socket.addEventListener('open', () => {
            socket.send('getJson');
        });

        // When a message is received from the server, parse the JSON and create the planets and wormholes
        socket.addEventListener('message', event => {
            const data = JSON.parse(event.data);
            console.log(data);
            drawUi(data);
            // Create the planets and wormholes using the data object
        });
    }
  
    const getGameKey = async () => {
    	const response = await fetch(`${UrlRoot}/getGameKey`);

    	currentGameKey = (await response.json()).key;

        gameKeySelector.addAndSelectItem({
            display: `${new Date().toISOString()} - ${currentGameKey}`,
            value: currentGameKey
        });
 	};
  
 	const createGame = async () => {

        const dropdownList = document.getElementById("dropdownList");
        const selectedType = dropdownList.value;

 	    const gameConfig = {
	   		bots: [1],
	   		gameType: selectedType
 	    };

        console.log('create game with config ' + gameConfig)
 	    
 	    const response = await fetch(`${UrlRoot}/createGame/${currentGameKey}`, {
 	    	method: 'POST',
 	    	headers: {
 	    	   'Content-Type': 'application/json',
    	    },
 	    	body: JSON.stringify(gameConfig)
 	    });
 	    
 	    const gameCreatedResult = await response.json();
 	    
 	    console.log(gameCreatedResult);
 	    currentGameId = gameCreatedResult.gameId;
 	    
         gameIdSelector.addAndSelectItem({
            display: `${new Date().toISOString()} - ${currentGameId}`,
            value: currentGameKey
        });
    };
  
    const connectWebSocket = async () => {
    	const response = await fetch(`${UrlRoot}/connect/${currentGameId}/${currentGameKey}`);
    };
  
    const startGame = async () => {
    	const response = await fetch(`${UrlRoot}/startGame/${currentGameId}/${currentGameKey}`);
    	
    	console.log(await response.json());
    };
  
    const stopGame = async () => {
    	const response = await fetch(`${UrlRoot}/stopGame/${currentGameId}/${currentGameKey}`);
    	
    	console.log(await response.json());
    };

    const getBots = async () => {
        const response = await fetch(`${UrlRoot}/bots`);

        console.log(await response.json());
    };

    const testUi = async () => {
        const response = await fetch(`${UrlRoot}/test`);
    };

    const drawUi = async (jsonConfig) => {
        /*const jsonConfig = {
                width: 800,
                height: 600,
                planets: [
                    {
                        name: 'Planet 1',
                        x: 100,
                        y: 100,
                        radius: 25,
                        color: '#ff0000',
                        info: 'This is planet 1'
                    },
                    {
                        name: 'Planet 2',
                        x: 400,
                        y: 300,
                        radius: 25,
                        color: '#00ff00',
                        info: 'This is planet 2'
                    }
                ],
                wormholes: [
                    {
                        name: 'Wormhole 1',
                        x1: 200,
                        y1: 200,
                        x2: 500,
                        y2: 400,
                        color: '#000000',
                        info: 'This is wormhole 1'
                    }
                ]
            }
        };*/

        // Create the planets
        jsonConfig.planets.forEach((planet) => {
            const planetDiv = document.createElement('div');
            planetDiv.className = 'planet';
            planetDiv.style.width = 25 + 'px';
            planetDiv.style.height = 25 + 'px';
            planetDiv.style.backgroundColor = planet.color;
            planetDiv.style.left = planet.x - 25 + 'px';
            planetDiv.style.top = planet.y - 25 + 'px';

            const planetPopup = document.createElement('div');
            planetPopup.className = 'planet-popup';
            planetPopup.innerHTML = '<strong>' + planet.name + '</strong><br>' + planet.info;

            planetDiv.appendChild(planetPopup);
            document.getElementById('container').appendChild(planetDiv);
        });

        // Create the wormholes
        if (jsonConfig.wormholes) {
            jsonConfig.wormholes.forEach((wormhole) => {

                const dx = wormhole.x2 - wormhole.x1;
                const dy = wormhole.y2 - wormhole.y1;
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                const length = Math.sqrt(dx * dx + dy * dy);

                const wormholeDiv = document.createElement('div');
                wormholeDiv.className = 'wormhole';
                wormholeDiv.style.width = length + 'px';
                wormholeDiv.style.left = wormhole.x1 + 'px';
                wormholeDiv.style.top = wormhole.y1 - 5 + 'px';
                wormholeDiv.style.transform = 'rotate(' + angle + 'deg)';
                wormholeDiv.style.backgroundColor = wormhole.color;

                const wormholePopup = document.createElement('div');
                wormholePopup.className = 'wormhole-popup';
                wormholePopup.innerHTML = '<strong>' + wormhole.name + '</strong><br>' + wormhole.info;

                wormholeDiv.appendChild(wormholePopup);
                document.getElementById('container').appendChild(wormholeDiv);
            })
        }
    }

    const historyDropDownInitializer = async (endpointUrl, dropdown) => {
        const response = await fetch(endpointUrl);

        const items = (await response.json())
            .map(x => {
                return {
                    display: `${new Date(x.createdAt).toISOString()} - ${x.value}`,
                    value: x.value
                };
            });

        items.sort((lhs, rhs) => -lhs.display.localeCompare(rhs.display))

        dropdown.addItems(items);
    };

    historyDropDownInitializer(`${UrlRoot}/gameKeyHistory`, gameKeySelector);
    historyDropDownInitializer(`${UrlRoot}/gameIdHistory`, gameIdSelector);

    joinUiSocket();    
  
</script>
</body>
</html>