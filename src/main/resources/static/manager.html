<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Game Control Panel</title>
    <style>

        :root {
            --render-area-padding: 10px;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
        }

        button {
            background-color: #2BA3C1;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-right: 20px;
            margin-bottom: 10px;
            cursor: pointer;
            min-width: 240px;
        }

        select {
            padding: 10px 20px;
            text-align: center;
            display: inline-block;
            font-size: 16px;
            margin-right: 20px;
            margin-bottom: 10px;
            cursor: pointer;
            min-width: 240px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            margin-right: 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .planet {
            position: absolute;
            border-radius: 50%;
            transition: transform 0.2s;
            translate: var(--render-area-padding) var(--render-area-padding);
        }

        .planet-popup {
            position: relative;
            background-color: white;
            border: 1px solid black;
            padding: 10px;
            display: none;
        }

        .planet:hover .planet-popup {
            display: block;
            z-index: 1;
        }

        .wormhole {
            position: relative;
            background-color: black;
            height: 10px;
            width: 10px;
            transition: transform 0.2s;
            z-index: 0;
        }

        .wormhole:hover {
            transform: scale(1.2);
            z-index: 1;
        }

        .wormhole-popup {
            position: relative;
            background-color: white;
            border: 1px solid black;
            padding: 10px;
            display: none;
        }

        .wormhole:hover + .wormhole-popup {
            display: block;
        }

        #container {
            border: solid black;
            height: 100%;
            background-color: #EEEEEE;
            box-sizing: border-box; /* add this line */
            padding: 20px; /* add your desired padding */
            position: relative;
        }

        main {
            flex: 1;
            display: flex; /* add this line */
            flex-direction: column; /* add this line */
            box-sizing: border-box; /* add this line */
            padding: 10px; /* add your desired padding */
        }
    </style>
</head>
<body>

<h1>Game Control Panel</h1>

<main>
    <div>
        <button type="button" onclick="joinUiSocket()">Join websocket for UI</button>
        <input type="text" id="txbConnectedToServer" readonly>
    </div>

    <div>
        <button type="button" onclick="getGameKey()">Get Game Key</button>
        <select id="selGameKey">
        </select>
    </div>

    <div>
        <button type="button" onclick="createGame()">Create Game</button>
        <select id="dropdownList">
            <option value="SINGLE_PLAYER">SINGLE_PLAYER</option>
            <option value="MULTI_PLAYER">MULTI_PLAYER</option>
            <option value="QUALIFYING">QUALIFYING</option>
        </select>
        <select id="selGameId">
        </select>
    </div>

    <div>
        <button type="button" onclick="connectWebSocket()">Connect Control WebSocket</button>
    </div>

    <div>
        <button type="button" onclick="startGame()">Start Game</button>
        <button type="button" onclick="stopGame()">Stop Game</button>
    </div>

    <div>
        <button type="button" onclick="getBots()">Get Bots</button>
        <button type="button" onclick="testUi()">Test</button>
    </div>

    <div id="container">
    </div>

</main>


<script type="text/javascript" src="js/game-manager.js"></script>
<script type="text/javascript" src="js/dropdownlist.js"></script>
<script type="text/javascript" src="js/ui-controller.js"></script>
<script type="text/javascript">

    const gameManager = new GameManager();
    const uiController = new UIController('container');
    const colors = ["gray", "red", "blue", "green", "yellow", "orange", "purple", "pink", "brown"];
    const playerDict = {
        0: 0
    };

    const gameKeySelector = new DropdownList("selGameKey", event => gameManager.currentGameKey = event.target.value);
    const gameIdSelector = new DropdownList("selGameId", event => gameManager.currentGameId = event.target.value);

    gameManager.currentGameKey = gameKeySelector.selected;
    gameManager.currentGameId = gameIdSelector.selected;

    const joinUiSocket = async () => {
        // Create a new WebSocket connection to the server
        const socket = new WebSocket(`ws://localhost:8080/planets`);

        socket.addEventListener('open', (event) => {
            const txbConnectedToServer = document.getElementById('txbConnectedToServer');
            txbConnectedToServer.value = "Open";
        });

        socket.addEventListener('close', (event) => {
            const txbConnectedToServer = document.getElementById('txbConnectedToServer');
            txbConnectedToServer.value = "Closed";
        });

        // When the WebSocket connection is open, send a message to request the JSON data
        socket.addEventListener('open', () => {
            socket.send('getJson');
        });

        // When a message is received from the server, parse the JSON and create the planets and wormholes
        socket.addEventListener('message', event => {
            const data = JSON.parse(event.data);
            console.log(data);
            drawUi(data);
            // Create the planets and wormholes using the data object
        });
    }
  
    const getGameKey = async () => {
    	const response = await gameManager.getGameKey();

        gameKeySelector.addAndSelectItem({
            display: `${new Date().toISOString()} - ${response}`,
            value: response
        });
 	};
  
 	const createGame = async () => {

        const dropdownList = document.getElementById("dropdownList");
        const selectedType = dropdownList.value;

 	    const gameConfig = new GameConfig([1], selectedType);
        const response = await gameManager.createGame(gameConfig);
 	    
        gameIdSelector.addAndSelectItem({
            display: `${new Date().toISOString()} - ${response}`,
            value: response
        });
    };
  
    const connectWebSocket = async () =>
    	await gameManager.connectWebSocket();
  
    const startGame = async () =>
    	await gameManager.startGame();
  
    const stopGame = async () =>
    	await gameManager.stopGame();

    const getBots = async () =>
        await gameManager.getBots();

    const testUi = async () => {
        const response = await fetch(`${GameManager.UrlRoot}/test`);
    };

    const createPlanet = (planet, scale) => {
        const planetDiv = document.createElement('div');
        planetDiv.id = 'planet' + planet.id;
        planetDiv.className = 'planet';
        planetDiv.style.width = 2 * scale + 'px';
        planetDiv.style.height = 2 * scale + 'px';
        planetDiv.style.backgroundColor = colors[playerDict[planet.player]];
        planetDiv.style.left = planet.x * scale + 'px';
        planetDiv.style.top = planet.y * scale + 'px';
        planetDiv.style.position = 'absolute';
        const planetPopup = document.createElement('div');
        planetPopup.className = 'planet-popup';
        planetPopup.innerHTML = '<strong>' + 'id: ' + planet.id + '</strong><br>'
        '{ ' + planet.x + ', ' + planet.y + '}' +  '<br>' +
        'player: ' + planet.player + '<br>';
        planetPopup.style.width = 50 + 'px';
        planetPopup.style.height = 50 + 'px';
        planetDiv.appendChild(planetPopup);
        document.getElementById('container').appendChild(planetDiv);
    }

    const drawLine = (x, y, len, angleRad) => {
        let container = document.getElementById('container');
        // Convert angle from degrees to radians
        // Calculate the end point of the line
        const endX = x + len * Math.cos(angleRad);
        const endY = y + len * Math.sin(angleRad);

        // Create a new div element to represent the line
        const line = document.createElement("div");

        // Set the position and dimensions of the line
        line.style.position = "absolute";
        line.style.top = y + "px";
        line.style.left = x + "px";
        line.style.width = len + "px";
        line.style.height = "0px";

        // Apply a border to the line to represent the stroke
        line.style.borderTop = "1px solid black";

        // Rotate the line to match the angle
        line.style.transform = `rotate(${angleRad + Math.PI/2}rad)`;

        // Add the line to the DOM
        container.appendChild(line);
    }



    const drawUi = async (jsonConfig) => {

        let scale = 5;

        if(jsonConfig.eventType === 'GAME_STARTED'){
            let container = document.getElementById('container')
            container.style.width = (jsonConfig.width + 1) * scale + 'px';
            container.style.height = (jsonConfig.height + 1) * scale + 'px';
            container.style.position = 'relative';

            let players = jsonConfig.players;
            console.log(players);
            for (let i = 0; i < players.length; i++) {
                console.log(players[i]);
                playerDict[players[i].id] = i+1;
            }
            console.log(playerDict);

        }

        if (jsonConfig.eventType === 'ACTION_EFFECT') {
            let actionEffect = jsonConfig.actionEffect;
            let p = document.getElementById('planet' + actionEffect.id)
            console.log(p.style.left, p.style.top, scale*10, actionEffect.dir)

            drawLine(parseInt(p.style.left), parseInt(p.style.top), scale*10, actionEffect.dir);

        } else {


            // Create the planets
            jsonConfig.planets.forEach((planet) => {
                let p = document.getElementById('planet' + planet.id)
                if(p==null){
                    createPlanet(planet, scale);
                } else {
                    p.style.backgroundColor = colors[playerDict[planet.player]];
                    p.firstChild.innerHTML = '<strong>' + planet.id + '</strong><br>'
                        + planet.x + ', ' + planet.y + '<br>';
                }

            });
            // Create the wormholes
            if (jsonConfig.wormholes) {
                jsonConfig.wormholes.forEach((wormhole) => {
                    const dy = wormhole.x2 - wormhole.x1;
                    const dx = wormhole.y2 - wormhole.y1;
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const wormholeDiv = document.createElement('div');
                    wormholeDiv.className = 'wormhole';
                    wormholeDiv.style.width = length + 'px';
                    wormholeDiv.style.left = wormhole.x1 + 'px';
                    wormholeDiv.style.top = wormhole.y1 - 5 + 'px';
                    wormholeDiv.style.transform = 'rotate(' + angle + 'deg)';
                    wormholeDiv.style.backgroundColor = wormhole.color;

                    const wormholePopup = document.createElement('div');
                    wormholePopup.className = 'wormhole-popup';
                    wormholePopup.innerHTML = '<strong>' + wormhole.name + '</strong><br>' + wormhole.info;

                    wormholeDiv.appendChild(wormholePopup);
                    document.getElementById('container').appendChild(wormholeDiv);
                })
            }
    }

    /**
     * @param {string} endpointUrl
     * @param {DropdownList} dropdown
     */
    const historyDropDownInitializer = async (endpointUrl, dropdown) => {
        const response = await fetch(endpointUrl);

        const items = (await response.json())
            .map(x => {
                return {
                    display: `${new Date(x.createdAt).toISOString()} - ${x.value}`,
                    value: x.value
                };
            });

        items.sort((lhs, rhs) => -lhs.display.localeCompare(rhs.display))

        dropdown.addItems(items);
        dropdown.selectFirstItem();
    };

    historyDropDownInitializer(`${GameManager.UrlRoot}/gameKeyHistory`, gameKeySelector);
    historyDropDownInitializer(`${GameManager.UrlRoot}/gameIdHistory`, gameIdSelector);

    joinUiSocket();
    loadDummyUIConfig();
  
</script>
</body>
</html>